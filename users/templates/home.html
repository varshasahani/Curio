{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">All Questions</h2>
    <div class="list-group">
        {% for question in questions %}
            <div class="list-group-item">
                <h5 class="mb-1">{{ question.title }}</h5>
                <p class="mb-1">{{ question.body|truncatechars:100 }}</p>
                <small class="text-muted">Posted by {{ question.user.email }} on {{ question.created_at|date:"F j, Y, g:i a" }}</small>
                {% if user.is_authenticated %}
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary reply-button" data-question-id="{{ question.id }}">Reply</button>
                    <button class="btn btn-sm btn-outline-primary like-button" data-question-id="{{ question.id }}">
                        Like ({{ question.likes.count }})
                    </button>
                </div>
                <!-- Replies Section -->
                <div class="mt-3" id="replies-{{ question.id }}">
                    <h6>Replies:</h6>
                    {% for reply in question.replies.all|slice:":1" %}
                        <div class="border p-2 mb-2">
                            <p>{{ reply.body }}</p>
                            <small class="text-muted">By {{ reply.user.username }} on {{ reply.created_at|date:"F j, Y, g:i a" }}</small>
                        </div>
                    {% endfor %}
                    {% if question.replies.count > 1 %}
                        <a href="{% url 'question_detail' question.id %}" class="btn btn-link">View all {{ question.replies.count }} replies</a>
                    {% endif %}
                </div>
                <!-- Hidden reply form -->
                <div class="reply-form mt-3" id="reply-form-{{ question.id }}" style="display: none;">
                    <form method="post" class="reply-to-question-form" data-question-id="{{ question.id }}">
                        {% csrf_token %}
                        <textarea name="body" class="form-control mb-2" rows="3" placeholder="Write your reply here..."></textarea>
                        <button type="submit" class="btn btn-primary btn-sm">Submit Reply</button>
                    </form>
                </div>
                {% endif %}
            </div>
        {% empty %}
            <p class="text-center">No questions have been posted yet.</p>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Toggle reply form visibility
        const replyButtons = document.querySelectorAll('.reply-button');
        replyButtons.forEach(button => {
            button.addEventListener('click', function () {
                const questionId = this.getAttribute('data-question-id');
                const replyForm = document.getElementById(`reply-form-${questionId}`);
                if (replyForm.style.display === 'none') {
                    replyForm.style.display = 'block';
                } else {
                    replyForm.style.display = 'none';
                }
            });
        });

        // Handle reply form submission
        const replyForms = document.querySelectorAll('.reply-to-question-form');
        replyForms.forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const questionId = this.getAttribute('data-question-id');
                const formData = new FormData(this);

                fetch(`/reply/${questionId}/`, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close the reply form
                        const replyForm = document.getElementById(`reply-form-${questionId}`);
                        replyForm.style.display = 'none';

                        // Update the replies section
                        const repliesDiv = document.getElementById(`replies-${questionId}`);
                        repliesDiv.innerHTML = data.replies_html;
                    } else {
                        alert('Failed to submit reply.');
                    }
                });
            });
        });
    });
</script>
{% endblock %}